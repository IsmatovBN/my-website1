<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <title>Statistics - EliteAsphalt</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#1a365d",
            secondary: "#4a5568",
            accent: "#f59e0b",
            lightBg: "#f7fafc",
          },
        },
      },
    };
  </script>
</head>
<body class="bg-lightBg text-secondary font-inter">
  <aside class="fixed inset-y-0 left-0 z-40 w-64 bg-primary text-white transform -translate-x-full lg:translate-x-0 transition">
    <div class="flex items-center justify-between p-4 border-b border-white/10">
      <h1 class="text-xl font-bold">EliteAsphalt</h1>
    </div>
    <nav class="p-4 space-y-3">
      <a href="/admin.html#create" class="nav-link"><i class="ri-add-circle-line mr-2"></i>Yangi post</a>
      <a href="/admin.html#list" class="nav-link"><i class="ri-list-check mr-2"></i>Postlar</a>
      <a href="#" class="nav-link active"><i class="ri-bar-chart-2-line mr-2"></i>Statistika</a>
      <a href="/" target="_blank" class="nav-link"><i class="ri-eye-line mr-2"></i>Saytga o‘tish</a>
    </nav>
  </aside>

  <main class="min-h-screen lg:ml-64 p-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-2xl shadow-card p-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-500">Jami postlar</span>
          <i class="ri-file-list-3-line text-2xl text-accent"></i>
        </div>
        <div id="totalPosts" class="text-3xl font-bold text-primary">0</div>
      </div>
      <div class="bg-white rounded-2xl shadow-card p-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-500">Yangiliklar</span>
          <i class="ri-newspaper-line text-2xl text-accent"></i>
        </div>
        <div id="newsCount" class="text-3xl font-bold text-primary">0</div>
      </div>
      <div class="bg-white rounded-2xl shadow-card p-6">
        <div class="flex items-center justify-between mb-2">
          <span class="text-gray-500">Loyihalar</span>
          <i class="ri-folder-line text-2xl text-accent"></i>
        </div>
        <div id="projCount" class="text-3xl font-bold text-primary">0</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-2xl shadow-card p-6">
        <h3 class="text-lg font-bold text-primary mb-4">Turi bo‘yicha</h3>
        <canvas id="pieChart" height="200"></canvas>
      </div>
      <div class="bg-white rounded-2xl shadow-card p-6">
        <h3 class="text-lg font-bold text-primary mb-4">Oxirgi 30 kun</h3>
        <canvas id="lineChart" height="200"></canvas>
      </div>
    </div>
  </main>

  <script>
    const BASE = '/api';
    const $ = id => document.getElementById(id);

    /* ---------- sidebar active ---------- */
    document.querySelector('.nav-link.active').classList.add('bg-white/10');

    /* ---------- load counts ---------- */
    async function loadStats() {
      const [news, proj] = await Promise.all([
        fetch(`${BASE}/news`).then(r => r.json()),
        fetch(`${BASE}/projects`).then(r => r.json()),
      ]);
      const n = news.length, p = proj.length;
      $('totalPosts').textContent = n + p;
      $('newsCount').textContent = n;
      $('projCount').textContent = p;
      drawPie(n, p);
      drawLine(news, proj);
    }

    /* ---------- pie ---------- */
    function drawPie(n, p) {
      new Chart($('pieChart'), {
        type: 'pie',
        data: {
          labels: ['Yangilik', 'Loyiha'],
          datasets: [{ data: [n, p], backgroundColor: ['#f59e0b', '#1a365d'] }],
        },
        options: { plugins: { legend: { position: 'bottom' } } },
      });
    }

    /* ---------- line (last 30 days) ---------- */
    function drawLine(news, proj) {
      const last30 = [...Array(30)].map((_, i) => {
        const d = new Date();
        d.setDate(d.getDate() - i);
        return d.toISOString().slice(0, 10);
      }).reverse();

      const countByDate = (arr) =>
        last30.map(d => arr.filter(o => o.date === d).length);

      new Chart($('lineChart'), {
        type: 'line',
        data: {
          labels: last30,
          datasets: [
            { label: 'Yangilik', data: countByDate(news), borderColor: '#f59e0b', tension: 0.3 },
            { label: 'Loyiha', data: countByDate(proj), borderColor: '#1a365d', tension: 0.3 },
          ],
        },
        options: { plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } },
      });
    }

    loadStats();
  </script>

  <style>
    .nav-link {
      @apply flex items-center px-3 py-2 rounded-lg text-white hover:bg-white/10 transition;
    }
  </style>
</body>
</html>