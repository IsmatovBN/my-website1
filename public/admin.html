<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8">
  <title>Admin ‚Äì EliteAsphalt</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    /* -------------- same styles you already had -------------- */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f8fafc;color:#334155}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{background:linear-gradient(135deg,#1e293b 0%,#334155 100%);color:white;padding:30px;border-radius:15px;margin-bottom:30px}
    .header h1{font-size:32px;margin-bottom:10px}
    .header-buttons{display:flex;gap:15px;margin-top:20px;flex-wrap:wrap}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s ease}
    .btn-primary{background:#3b82f6;color:white}
    .btn-accent{background:#f59e0b;color:#1e293b}
    .btn-danger{background:#ef4444;color:white}
    .btn-success{background:#10b981;color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,.15)}
    .card{background:white;border-radius:15px;padding:30px;margin-bottom:30px;box-shadow:0 4px 20px rgba(0,0,0,.08)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;font-weight:600;color:#1e293b}
    .form-control{width:100%;padding:14px;border:2px solid #e2e8f0;border-radius:10px;font-size:15px;transition:all .3s ease}
    .form-control:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}
    textarea.form-control{resize:vertical;min-height:150px}
    .table-modern{width:100%;border-collapse:collapse;margin-top:20px}
    .table-modern th{background:#f1f5f9;padding:16px;text-align:left;font-weight:600;color:#1e293b;border-bottom:2px solid #e2e8f0}
    .table-modern td{padding:16px;border-bottom:1px solid #e2e8f0}
    .table-modern tr:hover{background:#f8fafc}
    .alert{padding:16px;border-radius:10px;margin-bottom:20px;font-weight:500}
    .alert-success{background:#dcfce7;color:#166534;border:1px solid #bbf7d0}
    .alert-error{background:#fef2f2;color:#dc2626;border:1px solid #fecaca}
    .image-preview{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px;margin-top:15px}
    .image-preview .img-wrapper{position:relative;border-radius:10px;overflow:hidden}
    .image-preview img{width:100%;height:120px;object-fit:cover}
    .image-preview .remove-img{position:absolute;top:5px;right:5px;background:rgba(239,68,68,.9);color:white;border:none;border-radius:50%;width:25px;height:25px;cursor:pointer;font-size:14px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white;padding:25px;border-radius:15px;text-align:center}
    .stat-number{font-size:36px;font-weight:bold;margin-bottom:5px}
    .stat-label{opacity:.9;font-size:14px}
    .action-buttons{display:flex;gap:8px}
    .action-buttons button{padding:8px 16px;font-size:13px}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000}
    .modal-content{background:white;margin:50px auto;padding:30px;border-radius:15px;max-width:500px;position:relative}
    .close-modal{position:absolute;top:15px;right:20px;font-size:24px;cursor:pointer;color:#6b7280}
    @media(max-width:768px){.form-grid{grid-template-columns:1fr}.header-buttons{flex-direction:column}.action-buttons{flex-direction:column}}
  </style>
</head>
<body>
  <div class="container">
    <!-- HEADER -->
    <div class="header">
      <h1>üõ† EliteAsphalt Admin Panel</h1>
      <p>Professional boshqaruv tizimi ‚Äì 25+ yillik tajriba</p>
      <div class="header-buttons">
        <button class="btn btn-accent" onclick="showCreateForm()">‚ûï Yangi Post</button>
        <button class="btn btn-primary" onclick="loadAllPosts()">üîÑ Yangilash</button>
        <button class="btn btn-success" onclick="exportData()">üìä Export</button>
        <button class="btn btn-danger" onclick="logout()">üö™ Chiqish</button>
      </div>
    </div>

    <!-- ALERTS -->
    <div id="alerts"></div>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalPosts">0</div>
        <div class="stat-label">Jami Postlar</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#10b981 0%,#059669 100%)">
        <div class="stat-number" id="newsPosts">0</div>
        <div class="stat-label">Yangiliklar</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%)">
        <div class="stat-number" id="projectPosts">0</div>
        <div class="stat-label">Loyihalar</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%)">
        <div class="stat-number" id="todayPosts">0</div>
        <div class="stat-label">Bugun</div>
      </div>
    </div>

    <!-- CREATE/EDIT FORM -->
    <div id="createForm" class="card" style="display:none">
      <h2 id="formTitle">üìù Yangi Post Yaratish</h2>
      <form id="postForm" onsubmit="savePost(event)">
        <input type="hidden" id="editId">
        <div class="form-grid">
          <div class="form-group">
            <label>Post Turi *</label>
            <select id="type" required class="form-control">
              <option value="">Tanlang‚Ä¶</option>
              <option value="news">üì∞ Yangilik</option>
              <option value="projects">üìÅ Loyiha</option>
            </select>
          </div>
          <div class="form-group">
            <label>Sarlavha *</label>
            <input type="text" id="title" required class="form-control" placeholder="Misol: Yangi yo'l qurilishi">
          </div>
        </div>
        <div class="form-group">
          <label>Matn *</label>
          <textarea id="body" required class="form-control" rows="6" placeholder="Post matnini yozing‚Ä¶"></textarea>
        </div>
        <div class="form-grid">
          <div class="form-group">
            <label>Sana</label>
            <input type="date" id="date" class="form-control">
          </div>
          <div class="form-group">
            <label>Muallif</label>
            <input type="text" id="author" class="form-control" placeholder="Ismingiz">
          </div>
        </div>
        <!-- IMAGES -->
        <div class="form-group">
          <label>Rasmlar</label>
          <input type="file" id="images" multiple accept="image/*" class="form-control" onchange="previewImages(event)">
          <div id="imagePreview" class="image-preview"></div>
          <small>Rasm havolalari (vergul bilan ajrating):</small>
          <input type="text" id="imageUrls" class="form-control" placeholder="https://site.com/rasm1.jpg, https://site.com/rasm2.jpg">
        </div>
        <!-- VIDEO -->
        <div class="form-group">
          <label>Video havolasi</label>
          <input type="text" id="video" class="form-control" placeholder="https://youtube.com/watch?v=‚Ä¶" oninput="previewVideo(this.value)">
          <div id="videoPreview"></div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px">
          <button type="submit" class="btn btn-accent">üíæ Saqlash</button>
          <button type="button" onclick="cancelEdit()" class="btn btn-primary">‚ùå Bekor qilish</button>
        </div>
      </form>
    </div>

    <!-- POSTS LIST -->
    <div class="card">
      <h2>üìã Postlar Ro'yxati</h2>
      <div style="position:relative;margin-bottom:20px">
        <input type="text" id="searchInput" class="form-control" placeholder="üîç Qidirish‚Ä¶" onkeyup="searchPosts()" style="padding-left:45px">
        <span style="position:absolute;left:15px;top:50%;transform:translateY(-50%)">üîç</span>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <select id="filterType" onchange="filterPosts()" class="form-control" style="width:auto">
          <option value="">Barcha turlar</option>
          <option value="news">Yangiliklar</option>
          <option value="projects">Loyihalar</option>
        </select>
        <select id="filterDate" onchange="filterPosts()" class="form-control" style="width:auto">
          <option value="">Barcha sanalar</option>
          <option value="today">Bugun</option>
          <option value="week">Oxirgi hafta</option>
          <option value="month">Oxirgi oy</option>
        </select>
        <button onclick="resetFilters()" class="btn btn-primary">‚ôª Tozalash</button>
      </div>
      <div style="overflow-x:auto">
        <table class="table-modern">
          <thead>
            <tr>
              <th>üìù Sarlavha</th><th>üè∑ Tur</th><th>üìÖ Sana</th><th>üë§ Muallif</th><th>üì∑ Rasmlar</th><th>üé• Video</th><th>‚öô Amallar</th>
            </tr>
          </thead>
          <tbody id="postsTable"><tr><td colspan="7" style="text-align:center;padding:40px">Yuklanmoqda‚Ä¶</td></tr></tbody>
        </table>
      </div>
      <div id="pagination" style="display:flex;justify-content:center;gap:10px;margin-top:20px"></div>
    </div>
  </div>

  <!-- DELETE CONFIRMATION MODAL -->
  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeDeleteModal()">√ó</span>
      <h3>üóë Postni O'chirish</h3>
      <p id="deleteMessage">Rostan ham ushbu postni o'chirmoqchimisiz?</p>
      <div style="display:flex;gap:10px;margin-top:20px">
        <button class="btn btn-danger" onclick="confirmDelete()">üóë Ha, O'chirish</button>
        <button class="btn btn-primary" onclick="closeDeleteModal()">‚ùå Yo'q</button>
      </div>
    </div>
  </div>

  <script>
    /* =======================  GLOBALS  ======================= */
    let allPosts=[],filteredPosts=[],currentPage=1,postsPerPage=10,editingPost=null,postToDelete=null;
    const REVALIDATE_SECRET='dev';  // change in production
    /* =======================  UTILS  ======================= */
    function showAlert(msg,type='success'){
      const div=document.createElement('div');div.className=`alert alert-${type}`;div.textContent=msg;
      document.getElementById('alerts').appendChild(div);
      setTimeout(()=>div.remove(),3000);
    }
    /* =======================  FORM  ======================= */
    function showCreateForm(){
      editingPost=null;
      document.getElementById('createForm').style.display='block';
      document.getElementById('formTitle').textContent='üìù Yangi Post Yaratish';
      document.getElementById('postForm').reset();
      document.getElementById('date').value=new Date().toISOString().split('T')[0];
      document.getElementById('imagePreview').innerHTML='';
      document.getElementById('videoPreview').innerHTML='';
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function cancelEdit(){
      document.getElementById('createForm').style.display='none';
      document.getElementById('postForm').reset();
      document.getElementById('imagePreview').innerHTML='';
      document.getElementById('videoPreview').innerHTML='';
      editingPost=null;
    }
    function previewImages(ev){
      const preview=document.getElementById('imagePreview');
      preview.innerHTML='';
      [...ev.target.files].forEach(file=>{
        const rd=new FileReader();
        rd.onload=e=>{
          const wrap=document.createElement('div');wrap.className='img-wrapper';
          wrap.innerHTML=`<img src="${e.target.result}"><button type="button" class="remove-img" onclick="this.parentElement.remove()">√ó</button>`;
          preview.appendChild(wrap);
        };
        rd.readAsDataURL(file);
      });
    }
    function previewVideo(url){
      const pr=document.getElementById('videoPreview');
      if(!url){pr.innerHTML='';return;}
      if(url.includes('youtube')||url.includes('youtu.be')){
        const id=(url.split('v=')[1]||url.split('/').pop()).split('&')[0];
        pr.innerHTML=`<iframe width="300" height="200" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`;
      }else if(url.includes('vimeo')){
        const id=url.split('/').pop();
        pr.innerHTML=`<iframe width="300" height="200" src="https://player.vimeo.com/video/${id}" frameborder="0" allowfullscreen></iframe>`;
      }else{
        pr.innerHTML=`<video width="300" controls><source src="${url}">Your browser does not support the video tag.</video>`;
      }
    }
    /* =======================  SAVE  ======================= */
    async function savePost(ev){
      ev.preventDefault();
      const type=document.getElementById('type').value;
      const title=document.getElementById('title').value.trim();
      const body=document.getElementById('body').value.trim();
      const date=document.getElementById('date').value||new Date().toISOString().split('T')[0];
      const author=document.getElementById('author').value||'Admin';
      const video=document.getElementById('video').value;
      if(!title||title.length<3){showAlert('‚ùå Sarlavha kamida 3 ta belgi','error');return;}
      if(!body||body.length<10){showAlert('‚ùå Matn kamida 10 ta belgi','error');return;}
      /* collect images */
      const images=[];
      document.getElementById('imageUrls').value.split(',').forEach(u=>{if(u.trim())images.push(u.trim())});
      document.querySelectorAll('#imagePreview img').forEach(img=>{if(img.src.startsWith('data:'))images.push(img.src)});
      const post={
        id:editingPost?editingPost.id:Date.now().toString(),
        title,body,date,author,type,images,video,
        createdAt:editingPost?editingPost.createdAt:new Date().toISOString(),
        updatedAt:new Date().toISOString()
      };
      /* try server first */
      try{
        const method=editingPost?'PUT':'POST';
        const end=editingPost?`${type}/${encodeURIComponent(editingPost.title)}`:type;
        const r=await fetch(`/api/${end}`,{method,headers:{'Content-Type':'application/json'},body:JSON.stringify(post)});
        if(!r.ok)throw new Error('server save failed');
        showAlert(editingPost?'‚úÖ Yangilandi':'‚úÖ Yaratildi');
      }catch{
        /* fallback to local */
        const l=JSON.parse(localStorage.getItem('adminPosts')||'[]');
        const ex=l.findIndex(p=>p.id===post.id);
        ex>=0?l[ex]=post:l.push(post);
        localStorage.setItem('adminPosts',JSON.stringify(l));
        showAlert('‚úÖ Mahalliy xotiraga saqlandi (server bilan muammo)');
      }
      /* revalidate public pages */
      await fetch(`/api/revalidate?secret=${REVALIDATE_SECRET}`).catch(()=>{});
      cancelEdit();await loadAllPosts();
    }
    /* =======================  LOAD  ======================= */
    async function loadAllPosts(){
      let arr=[];
      try{
        const [n,p]=await Promise.all([fetch('/api/news').then(r=>r.ok?r.json():[]),fetch('/api/projects').then(r=>r.ok?r.json():[])]);
        arr=[...n.map(x=>({...x,type:'news',kind:'Yangilik'})),...p.map(x=>({...x,type:'projects',kind:'Loyiha'}))];
      }catch{}
      const local=JSON.parse(localStorage.getItem('adminPosts')||'[]');
      local.forEach(p=>{if(!arr.find(x=>x.id===p.id))arr.push({...p,kind:p.type==='news'?'Yangilik':'Loyiha'})});
      allPosts=arr.sort((a,b)=>new Date(b.date||b.createdAt)-new Date(a.date||a.createdAt));
      filteredPosts=[...allPosts];
      updateStats();renderPostsTable();
    }
    /* =======================  DELETE  ======================= */
    function deletePost(id,title,type){
      postToDelete={id,title,type};
      document.getElementById('deleteMessage').textContent=`"${title}" ni o'chirmoqchimisiz?`;
      document.getElementById('deleteModal').style.display='block';
    }
    function closeDeleteModal(){document.getElementById('deleteModal').style.display='none';postToDelete=null;}
    async function confirmDelete(){
      if(!postToDelete)return;
      const {id,title,type}=postToDelete;
      closeDeleteModal();
      /* server */
      try{
        await fetch(`/api/${type}/${encodeURIComponent(title)}`,{method:'DELETE',headers:{'Content-Type':'application/json'}});
      }catch{}
      /* local */
      const l=JSON.parse(localStorage.getItem('adminPosts')||'[]').filter(p=>p.id!==id&&p.title!==title);
      localStorage.setItem('adminPosts',JSON.stringify(l));
      allPosts=allPosts.filter(p=>p.id!==id&&p.title!==title);
      filteredPosts=filteredPosts.filter(p=>p.id!==id&&p.title!==title);
      renderPostsTable();updateStats();
      await fetch(`/api/revalidate?secret=${REVALIDATE_SECRET}`).catch(()=>{});
      showAlert('‚úÖ O\'chirildi');
    }
    /* =======================  EDIT  ======================= */
    function editPost(p){
      editingPost=p;
      document.getElementById('createForm').style.display='block';
      document.getElementById('formTitle').textContent='‚úè Postni Tahrirlash';
      ['type','title','body','date','author','video'].forEach(id=>{
        document.getElementById(id).value=p[id]||'';
      });
      document.getElementById('date').value=p.date?p.date.split('T')[0]:'';
      /* images */
      const iurl=p.images?p.images.filter(u=>!u.startsWith('data:')).join(', '):'';
      document.getElementById('imageUrls').value=iurl;
      const pr=document.getElementById('imagePreview');pr.innerHTML='';
      (p.images||[]).filter(u=>u.startsWith('data:')).forEach((u,idx)=>{
        const w=document.createElement('div');w.className='img-wrapper';
        w.innerHTML=`<img src="${u}" alt="img${idx}"><button type="button" class="remove-img" onclick="this.parentElement.remove()">√ó</button>`;
        pr.appendChild(w);
      });
      previewVideo(p.video||'');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    /* =======================  RENDER  ======================= */
    function renderPostsTable(){
      const tbody=document.getElementById('postsTable');
      const start=(currentPage-1)*postsPerPage,end=start+postsPerPage,page=filteredPosts.slice(start,end);
      if(!page.length){tbody.innerHTML='<tr><td colspan="7" style="text-align:center;padding:40px">Postlar topilmadi</td></tr>';return;}
      tbody.innerHTML=page.map(p=>`
        <tr>
          <td><div style="font-weight:600;color:#1e293b">${p.title}</div><div style="font-size:13px;color:#64748b;margin-top:4px">${p.body.substring(0,100)}${p.body.length>100?'...':''}</div></td>
          <td><span style="background:${p.type==='news'?'#3b82f6':'#10b981'};color:white;padding:6px 12px;border-radius:6px;font-size:12px;font-weight:600">${p.kind}</span></td>
          <td style="font-size:14px">${new Date(p.date||p.createdAt).toLocaleDateString('uz-UZ')}</td>
          <td style="font-size:14px">${p.author||'Noma\'lum'}</td>
          <td style="font-size:14px">${p.images?.length||0} üì∑</td>
          <td>${p.video?'üìπ':''}</td>
          <td><div class="action-buttons"><button class="btn btn-primary" onclick="editPost(${JSON.stringify(p).replace(/"/g,'&quot;')})">‚úè Tahrir</button><button class="btn btn-danger" onclick="deletePost('${p.id}','${p.title.replace(/'/g,"\\'")}','${p.type}')">üóë O'chirish</button></div></td>
        </tr>`).join('');
      renderPagination();
    }
    function renderPagination(){
      const total=Math.ceil(filteredPosts.length/postsPerPage),p=document.getElementById('pagination');
      if(total<=1){p.innerHTML='';return;}
      let h='';
      if(currentPage>1)h+=`<button class="btn btn-primary" onclick="changePage(${currentPage-1})">‚¨Ö Oldingi</button>`;
      const start=Math.max(1,currentPage-2),end=Math.min(total,currentPage+2);
      for(let i=start;i<=end;i++)h+=`<button class="${i===currentPage?'btn btn-accent':'btn btn-primary'}" onclick="changePage(${i})">${i}</button>`;
      if(currentPage<total)h+=`<button class="btn btn-primary" onclick="changePage(${currentPage+1})">Keyingi ‚û°</button>`;
      p.innerHTML=h;
    }
    function changePage(pg){currentPage=pg;renderPostsTable();window.scrollTo({top:0,behavior:'smooth'});}
    /* =======================  FILTER  ======================= */
    function searchPosts(){
      const s=document.getElementById('searchInput').value.toLowerCase(),t=document.getElementById('filterType').value,d=document.getElementById('filterDate').value;
      filteredPosts=allPosts.filter(p=>{
        const m=!s||p.title.toLowerCase().includes(s)||p.body.toLowerCase().includes(s)||p.author?.toLowerCase().includes(s);
        const k=!t||p.type===t;
        let r=true;
        if(d){const pd=new Date(p.date||p.createdAt),nd=new Date();
          if(d==='today')r=pd.toDateString()===nd.toDateString();
          if(d==='week')r=pd>=new Date(nd-7*864e5);
          if(d==='month')r=pd>=new Date(nd-30*864e5);}
        return m&&k&&r;
      });
      currentPage=1;renderPostsTable();
    }
    function filterPosts(){searchPosts();}
    function resetFilters(){
      ['searchInput','filterType','filterDate'].forEach(id=>document.getElementById(id).value='');
      filteredPosts=[...allPosts];currentPage=1;renderPostsTable();
    }
    /* =======================  STATS  ======================= */
    function updateStats(){
      const n=allPosts.filter(p=>p.type==='news').length,p=allPosts.filter(x=>x.type==='projects').length,t=allPosts.filter(x=>new Date(x.date||x.createdAt).toDateString()===new Date().toDateString()).length;
      document.getElementById('totalPosts').textContent=allPosts.length;
      document.getElementById('newsPosts').textContent=n;
      document.getElementById('projectPosts').textContent=p;
      document.getElementById('todayPosts').textContent=t;
    }
    /* =======================  EXPORT  ======================= */
    function exportData(){
      const data={exportDate:new Date().toISOString(),totalPosts:allPosts.length,posts:allPosts};
      const b=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}),u=URL.createObjectURL(b);
      const a=document.createElement('a');a.href=u;a.download=`eliteasphalt-posts-${new Date().toISOString().split('T')[0]}.json`;
      document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);
      showAlert('‚úÖ Export qilindi');
    }
    /* =======================  LOGOUT  ======================= */
    function logout(){if(confirm('Chiqishni xohlaysizmi?')){localStorage.removeItem('ea_at');localStorage.removeItem('adminPosts');location.href='/login.html';}}
    /* =======================  INIT  ======================= */
    document.addEventListener('DOMContentLoaded',()=>loadAllPosts());
  </script>
</body>
</html>